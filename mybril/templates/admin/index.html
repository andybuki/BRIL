{% extends "admin/base_site.html" %}
{% load i18n %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% load adminmedia %}{% admin_media_prefix %}css/dashboard.css" />
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block content %}

{% if user.is_staff %}
<script src="{{ STATIC_URL }}jquery/jquery-1.6.2.min.js"></script>
<script src="{{ STATIC_URL }}jquery/jquery-ui-1.8.15.custom.min.js"></script>
<script src="{{ STATIC_URL }}jquery/jquery.mousewheel.min.js"></script>
<script src="{{ STATIC_URL }}springy/springy.js"></script>
<script src="{{ STATIC_URL }}springy/springyui.js"></script>
<script src="{{ STATIC_URL }}contextMenu/jquery.ui.position.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}contextMenu/jquery.contextMenu.js" type="text/javascript"></script>
<link href="{{ STATIC_URL }}contextMenu/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
<link href="{{ STATIC_URL }}css/smoothness/jquery-ui-1.8.15.custom.css" rel="stylesheet" type="text/css" />

<script>
var graph = new Graph();
var graph2 = new Graph();

var n = [];

n[0] = graph.newNode({label: 'h2-2_MS_1_001.img', shape: 'circle', format: 'diffractionImage'});
n[1] = graph.newNode({label: 'h2-2_MS_1_002.img', shape: 'circle', format: 'diffractionImage'});
n[2] = graph.newNode({label: 'h2-2_MS_1_003.img', shape: 'circle', format: 'diffractionImage'});
n[3] = graph.newNode({label: 'h2-2_MS_1_004.img', shape: 'circle', format: 'diffractionImage'});
n[4] = graph.newNode({label: 'h2-2_MS_1_005.img', shape: 'circle', format: 'diffractionImage'});
n[5] = graph.newNode({label: 'DiffractionImageSet', shape: 'circle', format: 'diffractionImageSet'});
n[6] = graph.newNode({label: 'IntegrateDiffractionImagesProcess', shape: 'square'});
n[7] = graph.newNode({label: 'high.mtz', shape: 'circle', format: 'mtzReflectionFile'});

n[8] = graph.newNode({label: 'sort.com', shape: 'circle', format: 'comFile'});
n[9] = graph.newNode({label: 'CCP4 Process: SORTMTZ', shape: 'square'});
n[10] = graph.newNode({label: 'sort.log', shape: 'circle', format: 'logFile'});
n[11] = graph.newNode({label: 'sorted-high.mtz', shape: 'circle', format: 'mtzReflectionFile'});

n[12] = graph.newNode({label: 'scala1.com', shape: 'circle', format: 'comFile'});
n[13] = graph.newNode({label: 'CCP4 Process: SCALA', shape: 'square'});
n[14] = graph.newNode({label: 'scala1.log', shape: 'circle', format: 'logFile'});
n[15] = graph.newNode({label: 'scala1.mtz', shape: 'circle', format: 'mtzReflectionFile'});

n[16] = graph.newNode({label: 'truncate.com', shape: 'circle', format: 'comFile'});
n[17] = graph.newNode({label: 'CCP4 Process: TRUNCATE', shape: 'square', format: 'CCP4Process'});
n[18] = graph.newNode({label: 'truncate.log', shape: 'circle', format: 'logFile'});
n[19] = graph.newNode({label: 'truncate.mtz', shape: 'circle', format: 'mtzReflectionFile'});

n[20] = graph.newNode({label: 'free.com', shape: 'circle', format: 'comFile'});
n[21] = graph.newNode({label: 'CCP4 Process: FREERFLAG', shape: 'square', format: 'CCP4Process'});
n[22] = graph.newNode({label: 'free.log', shape: 'circle', format: 'logFile'});
n[23] = graph.newNode({label: '5d5.mtz', shape: 'circle', format: 'mtzReflectionFile'});

n[24] = graph.newNode({label: 'Mosflm', shape: 'hexagon'});
n[25] = graph.newNode({label: 'CCP4', shape: 'hexagon'});
n[26] = graph.newNode({label: 'CCP4', shape: 'hexagon'});
n[27] = graph.newNode({label: 'CCP4', shape: 'hexagon'});
n[28] = graph.newNode({label: 'CCP4', shape: 'hexagon'});

graph.newEdge(n[0], n[5], {color: '#00A0B0', text: 'isMemberOf'});
graph.newEdge(n[1], n[5], {color: '#00A0B0', text: 'isMemberOf'});
graph.newEdge(n[2], n[5], {color: '#00A0B0', text: 'isMemberOf'});
graph.newEdge(n[3], n[5], {color: '#00A0B0', text: 'isMemberOf'});
graph.newEdge(n[4], n[5], {color: '#00A0B0', text: 'isMemberOf'});

graph.newEdge(n[6], n[5], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[6], n[24], {color: '#DA70D6', text: 'wasControlledBy'});

graph.newEdge(n[7], n[6], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[7], n[5], {color: '#EB6841', text: 'wasDerivedFrom'});

graph.newEdge(n[9], n[7], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[9], n[8], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[10], n[9], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[11], n[9], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[9], n[25], {color: '#DA70D6', text: 'wasControlledBy'});

graph.newEdge(n[11], n[7], {color: '#EB6841', text: 'wasDerivedFrom'});

graph.newEdge(n[13], n[11], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[13], n[12], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[14], n[13], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[15], n[13], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[13], n[26], {color: '#DA70D6', text: 'wasControlledBy'});

graph.newEdge(n[15], n[11], {color: '#EB6841', text: 'wasDerivedFrom'});

graph.newEdge(n[17], n[15], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[17], n[16], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[18], n[17], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[19], n[17], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[17], n[27], {color: '#DA70D6', text: 'wasControlledBy'});

graph.newEdge(n[19], n[15], {color: '#EB6841', text: 'wasDerivedFrom'});

graph.newEdge(n[21], n[19], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[21], n[20], {color: '#6A4A3C', text: 'used'});
graph.newEdge(n[22], n[21], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[23], n[21], {color: '#7DBE3C', text: 'wasGeneratedBy'});
graph.newEdge(n[21], n[28], {color: '#DA70D6', text: 'wasControlledBy'});

graph.newEdge(n[23], n[19], {color: '#EB6841', text: 'wasDerivedFrom'});

function filter(key, opt) {
  if (opt != null) {
	  var filter_key;
	  switch (key)
	  {
		  case "all_process":
			  filter_key = "square";
			  break;
		  case "all_objects":
			  filter_key = "circle";
			  break;
		  case "all_controllers":
			  filter_key = "hexagon";
			  break;			
		  default:
			  filter_key = key;
			  break;
	  }
	  if (jQuery.data(opt, key) == null) {
	    var filtered_nodes = key + "_nodes";
	    jQuery.data(opt, filtered_nodes, graph2.filterNodes(filter_key));
		  jQuery.data(opt, key, true);		  
	  }
	  else {
		  var filtered_nodes = key + "_nodes";
		  graph2.merge(jQuery.data(opt, filtered_nodes));
		  jQuery.data(opt, key, null);		
	  }		
	}
}

function filter_relationships(key, opt) {
  if (opt != null) {
	  if (jQuery.data(opt, key) == null) {	
	    var filtered_relations = key + "_edges";	
		  jQuery.data(opt, filtered_relations, graph2.filterEdges(key));
		  jQuery.data(opt, key, true);
	  }
	  else {
		  var filtered_relations = key + "_edges";	
		  graph2.mergeEdges(jQuery.data(opt, filtered_relations));
		  jQuery.data(opt, key, null);
	  }
	}		
}

</script>
{% endif %}

<script>
	$(function() {
	
	  var $tab_title_input = $("#tab_title"),
		$tab_content_input = $("#tab_content");
    var tab_counter = 3;
		
		$("#unique_tab_id").html("Relationship Explorer");
		
		var $tabs = $( "#tabs" ).tabs();		 
		
		function loadTab(expId) {
			var new_canvas = "<canvas id='explorer'/" + "></canvas>";
			$( "#tabs-3" ).html("");
			$( "#tabs-3" ).append( "<p><font size='4'><b>Experiment: " + expId + "</b></font>&nbsp;&nbsp;&nbsp;&nbsp;" + 
			                       "<button id='back_exp'>Back to Experiments</button><button id='reload'>Reload Relationships</button>"+ 
			                       "<button id='savePNG'>Save as PNG</button><button id='reset'>Reset Zoom</button></p>" );
			var pos_left = (window.innerWidth - 100)/2 - 50;
			var pos_top = (window.innerHeight - 250)/2;
			$( "#tabs-3" ).append( "<div id='loader2' style='display:none;'><p><img style='position: absolute; left: "+pos_left+"px; top: "+pos_top+"px;'" + 
			                       "src='{{ STATIC_URL }}jquery/ajax-loader.gif' alt='Loading'></p><div>" );                       
			$( "#tabs-3" ).append( new_canvas );
			var canvas_path = "#tabs #tabs-3 #explorer";
			$tabs.tabs('select', '#tabs-3');
			if (expId == 1)	
			{
	      jQuery(canvas_path).springy({ 'graph': graph });
	    } else {
	      var url = "http://localhost:8000/repo/experiments/" + expId + "/relationships/";	      	      
	      jQuery(canvas_path).springy({ 'graph': graph2 });   	   

	      $('#loader2').show();
	      $.getJSON(url, function(data) {
	          $('#loader2').hide();
	          graph2.loadData(data);	          
	      });
	    }
			
			$("#unique_tab_id").html("Relationship Explorer: " + expId);
				
			/**************************************************
      * Menu for filtering display
      **************************************************/		 
      
      // use a django template to fill this in automatically?
      
      $.contextMenu({
          // define which elements trigger this menu
          selector: "#explorer",
          // define the elements of the menu
          items: {	    	    	
          	all_process: {name: "Filter Processes", type:'checkbox', callback: filter},
          	sep1: "---------",
              all_objects: {name: "Filter Objects",  type:'checkbox', callback: filter},
              sep2: "---------",
              all_controllers: {name: "Filter Controllers", type:'checkbox', callback: filter},
	        sep3: "---------",
	        relationships_menu: {
		        name: "Filter Relationships",				
		        items: {
			        all_relationships: {name: "All",  type:'checkbox', callback: filter_relationships},
			        isMemberOf: {name: "isMemberOf",  type:'checkbox', callback: filter_relationships},
			        used: {name: "used",  type:'checkbox', callback: filter_relationships},
			        wasGeneratedBy: {name: "wasGeneratedBy",  type:'checkbox', callback: filter_relationships},
			        wasDerivedFrom: {name: "wasDerivedFrom",  type:'checkbox', callback: filter_relationships},
			        wasControlledBy: {name: "wasControlledBy",  type:'checkbox', callback: filter_relationships},
			        wasTriggeredBy: {name: "wasTriggeredBy",  type:'checkbox', callback: filter_relationships}
		        }
	        },	        	       
          },
          events: {
	        show: function(opt) {					
		        $.each(opt.inputs, function(key, item) {					
			        item.selected = jQuery.data(opt, key) ? true : null;										
		        });				
	        }
        }
      });
      
      $( "#reset" )
			.button()
			.click(function() {
			    // todo: how to reset the scale + location?
			    console.log(jQuery(canvas_path).springy.scale);
			});
      
      $( "#savePNG" )
			.button()
			.click(function() {
			    var save_canvas = document.getElementById("explorer");
          var img    = save_canvas.toDataURL("image/png");
          document.location.href = img.replace("image/png", "image/octet-stream");
			});
      
      $( "#reload" )
			.button()
			.click(function() {
	        var url = "http://localhost:8000/repo/experiments/" + expId + "/relationships/";
	        $('#loader2').show();
	        $.getJSON(url, function(data) {
	          $('#loader2').hide();
	          graph2.clearGraph();
	          graph2.loadData(data);	          
	        });	        
			});
      
      $( "#back_exp" )
			.button()
			.click(function() {
          $("#unique_tab_id").html("Relationship Explorer");
          $( "#tabs-3" ).html("<h2 id='note'>Please select an experiment to view it's relationships.</h2>");
          $("#dialog").dialog('close');
          $tabs.tabs('select', '#tabs-2');
			});      
		}    
 
		$( "#add_tab_1" )
			.button()
			.click(function() {
				loadTab(1);
			});
		
	  $( "#add_tab_2" )
			.button()
			.click(function() {
				loadTab($( "#add_tab_2" ).attr("value"));
			});
		
		$( "#tabs span.ui-icon-close" ).live( "click", function() {
			var index = $( "li", $tabs ).index( $( this ).parent() );					
			$tabs.tabs( "remove", index);
		});
		
	});
</script>

<div id="details-dialog" style="width:600px;overflow:auto">
  <div id="loader" class="loader" style="display:none;">
	    <img class="img-loader" src="{{ STATIC_URL }}jquery/ajax-loader.gif" alt="Loading"/>
	</div>
  <div id="msg"></div>
</div>

<div id="viewer-dialog" style="width:600px;overflow:auto">
  <div id="viewer"></div>
</div>

<div id="tabs" >
	<ul>
	  {% if user.is_superuser %}
		  <li><a href="#tabs-1">Admin</a></li>
		{% endif %} 
		  <li><a href="#tabs-2">Experiment Browser</a></li>  
		  <li><a href="#tabs-3"><span id='unique_tab_id'></a></li>
	</ul>
	{% if user.is_superuser %}
	<div id="tabs-1" class="ui-helper-clearfix">
              
        <div id="content-main">
        {% if app_list %}
            {% for app in app_list %}
                <div class="module">
                <table summary="{% blocktrans with app.name as name %}Models available in the {{ name }} application.{% endblocktrans %}">
                <caption><a href="{{ app.app_url }}" class="section">{% blocktrans with app.name as name %}{{ name }}{% endblocktrans %}</a></caption>
                {% for model in app.models %}
                    <tr>
                    {% if model.perms.change %}
                        <th scope="row"><a href="{{ model.admin_url }}">{{ model.name }}</a></th>
                    {% else %}
                        <th scope="row">{{ model.name }}</th>
                    {% endif %}

                    {% if model.perms.add %}
                        <td><a href="{{ model.admin_url }}add/" class="addlink">{% trans 'Add' %}</a></td>
                    {% else %}
                        <td>&nbsp;</td>
                    {% endif %}

                    {% if model.perms.change %}
                        <td><a href="{{ model.admin_url }}" class="changelink">{% trans 'Change' %}</a></td>
                    {% else %}
                        <td>&nbsp;</td>
                    {% endif %}
                    </tr>
                {% endfor %}
                </table>
                </div>
            {% endfor %}
        {% endif %}
        </div>
        
        {% block sidebar %}
        <div id="content-related">
            <div class="module" id="recent-actions-module">
                <h2>{% trans 'Recent Actions' %}</h2>
                <h3>{% trans 'My Actions' %}</h3>
                {% load log %}
                {% get_admin_log 10 as admin_log for_user user %}
                {% if not admin_log %}
                <p>{% trans 'None available' %}</p>
                {% else %}
                <ul class="actionlist">
                {% for entry in admin_log %}
                <li class="{% if entry.is_addition %}addlink{% endif %}{% if entry.is_change %}changelink{% endif %}{% if entry.is_deletion %}deletelink{% endif %}">
                    {% if entry.is_deletion or not entry.get_admin_url %}
                        {{ entry.object_repr }}
                    {% else %}
                        <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
                    {% endif %}
                    <br/>
                    {% if entry.content_type %}
                        <span class="mini quiet">{% filter capfirst %}{% trans entry.content_type.name %}{% endfilter %}</span>
                    {% else %}
                        <span class="mini quiet">{% trans 'Unknown content' %}</span>
                    {% endif %}
                </li>
                {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% endblock %}        
	</div>
	<div id="tabs-2" class="ui-helper-clearfix">
		  <h2>Browse Experiments</h2>
      <button id="add_tab_1">Explore Relationships of Experiment 1</button>
      <br/>
      <br/>
      <hr/>
      <br/>
      <button id="add_tab_2" value="bril:exp-87ac3d68-eb0b-4bff-9ab7-b8fbddf2a49d">Explore Relationships of 'bril:exp-87ac3d68-eb0b-4bff-9ab7-b8fbddf2a49d'</button>  
	</div>
	<div id="tabs-3" class="ui-helper-clearfix">	
	    <h2 id="note">Please select an experiment to view it's relationships.</h2>
	</div>
	{% else %}
	<div id="tabs-2" class="ui-helper-clearfix">
	    <h2>Browse Experiments</h2>
      <button id="add_tab_1">Explore Relationships of Experiment 1</button>
      <br/>
      <br/>
      <hr/>
      <br/>    
      <button id="add_tab_2" value="bril:exp-87ac3d68-eb0b-4bff-9ab7-b8fbddf2a49d">Explore Relationships of 'bril:exp-87ac3d68-eb0b-4bff-9ab7-b8fbddf2a49d'</button>  
	</div>
	<div id="tabs-3" class="ui-helper-clearfix">
	<h2 id="note">Please select an experiment to view it's relationships.</h2>
	</div>
	{% endif %}
</div>
{% endblock %}
