{% extends "admin/base_site.html" %}
{% load i18n %}

{% block extrastyle %}{{ block.super }}
<link rel="stylesheet" type="text/css" href="{% load adminmedia %}{% admin_media_prefix %}css/dashboard.css" />
{% endblock %}

{% block coltype %}colM{% endblock %}

{% block bodyclass %}dashboard{% endblock %}

{% block breadcrumbs %}{% endblock %}

{% block content %}

{% if user.is_staff %}
<script src="{{ STATIC_URL }}jquery/jquery-1.6.2.min.js"></script>
<script src="{{ STATIC_URL }}jquery/jquery-ui-1.8.15.custom.min.js"></script>
<script src="{{ STATIC_URL }}jquery/jquery.mousewheel.min.js"></script>
<script src="{{ STATIC_URL }}springy/springyui.js"></script>
<script src="{{ STATIC_URL }}raphael/raphael-min.js"></script>
<script src="{{ STATIC_URL }}springy/springy-test.js"></script>
<script src="{{ STATIC_URL }}contextMenu/jquery.ui.position.js" type="text/javascript"></script>
<script src="{{ STATIC_URL }}contextMenu/jquery.contextMenu.js" type="text/javascript"></script>
<link href="{{ STATIC_URL }}contextMenu/jquery.contextMenu.css" rel="stylesheet" type="text/css" />
<link href="{{ STATIC_URL }}css/smoothness/jquery-ui-1.8.15.custom.css" rel="stylesheet" type="text/css" />

<script>
var graph = new Graph();

function filter(key, opt) {
  if (opt != null) {
	  var filter_key;
	  switch (key)
	  {
		  case "all_process":
			  filter_key = "square";
			  break;
		  case "all_objects":
			  filter_key = "circle";
			  break;
		  case "all_controllers":
			  filter_key = "hexagon";
			  break;			
		  default:
			  filter_key = key;
			  break;
	  }
	  if (jQuery.data(opt, key) == null) {
	    var filtered_nodes = key + "_nodes";
	    jQuery.data(opt, filtered_nodes, graph.filterNodes(filter_key));
		  jQuery.data(opt, key, true);		  
	  }
	  else {
		  var filtered_nodes = key + "_nodes";
		  graph.merge(jQuery.data(opt, filtered_nodes));
		  jQuery.data(opt, key, null);		
	  }		
	}
}

function filter_relationships(key, opt) {
  if (opt != null) {
	  if (jQuery.data(opt, key) == null) {	
	    var filtered_relations = key + "_edges";	
		  jQuery.data(opt, filtered_relations, graph.filterEdges(key));
		  jQuery.data(opt, key, true);
	  }
	  else {
		  var filtered_relations = key + "_edges";	
		  graph.mergeEdges(jQuery.data(opt, filtered_relations));
		  jQuery.data(opt, key, null);
	  }
	}		
}

</script>
{% endif %}

<script>
	$(function() {
	
	  var $tab_title_input = $("#tab_title"),
		$tab_content_input = $("#tab_content");
    var tab_counter = 3;
		var visual = null;
		
		$("#unique_tab_id").html("Relationship Explorer");
		
		var $tabs = $( "#tabs" ).tabs();		 
		
		function loadTab(expId, expTitle) {
			var new_canvas = "<canvas id='explorer'/" + "></canvas>";
			$( "#tabs-3" ).html("");
			$( "#tabs-3" ).append( "<p><font size='4'><b>Experiment: " + expTitle + "</b></font>&nbsp;&nbsp;&nbsp;&nbsp;" + 
			                       "<button id='back_exp'>Back to Experiments</button><button id='reload'>Reload Relationships</button>"+ 
			                       "<button id='savePNG'>Save as PNG</button><button id='exportORE'>Export Experiment using OAI-ORE format</button></p>" );
						                       
			var pos_left = (window.innerWidth - 100)/2 - 50;
			var pos_top = (window.innerHeight - 250)/2;
			$( "#tabs-3" ).append( "<div id='loader2' class='loader2-invisible'><p><img style='position: absolute; left: "+pos_left+"px; top: "+pos_top+"px;'" + 
			                       "src='{{ STATIC_URL }}jquery/ajax-loader.gif' alt='Loading'></p><div>" );                       
			$( "#tabs-3" ).append( new_canvas );
			var canvas_path = "#tabs #tabs-3 #explorer";
			$tabs.tabs('select', '#tabs-3');
      var url = "http://localhost:8000/repo/experiments/" + expId + "/relationships/";	      	      
      jQuery(canvas_path).springy({ 'graph': graph });   	   

      $('#loader2').removeClass('loader2-invisible');
      $('#loader2').addClass('loader2-visible');
      $.getJSON(url, function(data) {
          $('#loader2').addClass('loader2-invisible');
          $('#loader2').removeClass('loader2-visible');
          graph.loadData(data);	          
      });
			
			$("#unique_tab_id").html("Relationship Explorer: " + expTitle);
				
			/**************************************************
      * Menu for filtering display
      **************************************************/		 
      
      // use a django template to fill this in automatically?      
      $.contextMenu({
          // define which elements trigger this menu
          selector: "#explorer",
          // define the elements of the menu
          items: {	    	    	
            	all_process: {name: "Filter Processes", type:'checkbox', callback: filter},
            	sep1: "---------",
                all_objects: {name: "Filter Objects",  type:'checkbox', callback: filter},
                sep2: "---------",
                all_controllers: {name: "Filter Controllers", type:'checkbox', callback: filter},
	          sep3: "---------",
	          relationships_menu: {
		          name: "Filter Relationships",				
		          items: {
			          all_relationships: {name: "All",  type:'checkbox', callback: filter_relationships},
			          isMemberOf: {name: "isMemberOf",  type:'checkbox', callback: filter_relationships},
			          used: {name: "used",  type:'checkbox', callback: filter_relationships},
			          wasGeneratedBy: {name: "wasGeneratedBy",  type:'checkbox', callback: filter_relationships},
			          wasDerivedFrom: {name: "wasDerivedFrom",  type:'checkbox', callback: filter_relationships},
			          wasControlledBy: {name: "wasControlledBy",  type:'checkbox', callback: filter_relationships},
			          wasTriggeredBy: {name: "wasTriggeredBy",  type:'checkbox', callback: filter_relationships}
		          }
	          },	        	       
          },
          events: {
	        show: function(opt) {					
		        $.each(opt.inputs, function(key, item) {					
			        item.selected = jQuery.data(opt, key) ? true : null;										
		        });				
	        }
        }
      });        
      
      $( "#exportORE" )
			.button()
			.click(function() {
          window.location = "http://localhost:8000/repo/experiments/" + expId + "/ORE/";
      });			
      
      $( "#savePNG" )
			.button()
			.click(function() {
			    var save_canvas = document.getElementById("explorer");
          var img    = save_canvas.toDataURL("image/png");        
          window.location = img.replace("image/png", "image/octet-stream");
			});
      
      $( "#reload" )
			.button()
			.click(function() {
	        var url = "http://localhost:8000/repo/experiments/" + expId + "/relationships/";
	        $('#loader2').removeClass('loader2-invisible');
          $('#loader2').addClass('loader2-visible');
	        $.getJSON(url, function(data) {
	          $('#loader2').addClass('loader2-invisible');
            $('#loader2').removeClass('loader2-visible');
	          graph.clearGraph();
	          graph.loadData(data);	          
	        });	        
			});
      
      $( "#back_exp" )
			.button()
			.click(function() {
          $("#unique_tab_id").html("Relationship Explorer");
          $( "#tabs-3" ).html("<h2 id='note'>Please select an experiment to view it's relationships.</h2>");
          $("#dialog").dialog('close');
          $tabs.tabs('select', '#tabs-2');
			});      
		}    
 
		$( "#add_tab_1" )
			.button()
			.click(function() {
				loadTab($( "#add_tab_1" ).attr("value"), "IgyFc34");				
			});
		
	  $( "#add_tab_2" )
			.button()
			.click(function() {
				loadTab($( "#add_tab_2" ).attr("value"), "baa5d5");
			});
		
		$( "#tabs span.ui-icon-close" ).live( "click", function() {
			var index = $( "li", $tabs ).index( $( this ).parent() );					
			$tabs.tabs( "remove", index);
		});
		
	});
</script>

<div id="details-dialog" style="width:600px;overflow:auto">
  <div id="loader" class="loader" style="display:none;">
	    <img class="img-loader" src="{{ STATIC_URL }}jquery/ajax-loader.gif" alt="Loading"/>
	</div>
  <div id="msg"></div>
</div>

<div id="viewer-dialog" style="width:600px;overflow:auto">
  <div id="viewer"></div>
</div>

<div id="tabs" >
	<ul>
	  {% if user.is_superuser %}
		  <li><a href="#tabs-1">Admin</a></li>
		{% endif %} 
		  <li><a href="#tabs-2">Experiment Browser</a></li>  
		  <li><a href="#tabs-3"><span id='unique_tab_id'></a></li>
	</ul>
	{% if user.is_superuser %}
	<div id="tabs-1" class="ui-helper-clearfix">
              
        <div id="content-main">
        {% if app_list %}
            {% for app in app_list %}
                <div class="module">
                <table summary="{% blocktrans with app.name as name %}Models available in the {{ name }} application.{% endblocktrans %}">
                <caption><a href="{{ app.app_url }}" class="section">{% blocktrans with app.name as name %}{{ name }}{% endblocktrans %}</a></caption>
                {% for model in app.models %}
                    <tr>
                    {% if model.perms.change %}
                        <th scope="row"><a href="{{ model.admin_url }}">{{ model.name }}</a></th>
                    {% else %}
                        <th scope="row">{{ model.name }}</th>
                    {% endif %}

                    {% if model.perms.add %}
                        <td><a href="{{ model.admin_url }}add/" class="addlink">{% trans 'Add' %}</a></td>
                    {% else %}
                        <td>&nbsp;</td>
                    {% endif %}

                    {% if model.perms.change %}
                        <td><a href="{{ model.admin_url }}" class="changelink">{% trans 'Change' %}</a></td>
                    {% else %}
                        <td>&nbsp;</td>
                    {% endif %}
                    </tr>
                {% endfor %}
                </table>
                </div>
            {% endfor %}
        {% endif %}
        </div>
        
        {% block sidebar %}
        <div id="content-related">
            <div class="module" id="recent-actions-module">
                <h2>{% trans 'Recent Actions' %}</h2>
                <h3>{% trans 'My Actions' %}</h3>
                {% load log %}
                {% get_admin_log 10 as admin_log for_user user %}
                {% if not admin_log %}
                <p>{% trans 'None available' %}</p>
                {% else %}
                <ul class="actionlist">
                {% for entry in admin_log %}
                <li class="{% if entry.is_addition %}addlink{% endif %}{% if entry.is_change %}changelink{% endif %}{% if entry.is_deletion %}deletelink{% endif %}">
                    {% if entry.is_deletion or not entry.get_admin_url %}
                        {{ entry.object_repr }}
                    {% else %}
                        <a href="{{ entry.get_admin_url }}">{{ entry.object_repr }}</a>
                    {% endif %}
                    <br/>
                    {% if entry.content_type %}
                        <span class="mini quiet">{% filter capfirst %}{% trans entry.content_type.name %}{% endfilter %}</span>
                    {% else %}
                        <span class="mini quiet">{% trans 'Unknown content' %}</span>
                    {% endif %}
                </li>
                {% endfor %}
                </ul>
                {% endif %}
            </div>
        </div>
        {% endblock %}        
	</div>
	<div id="tabs-2" class="ui-helper-clearfix">
		  <h2>Browse Experiments</h2>
      <button id="add_tab_1" value="bril:exp-5774e47e-2b23-4ae4-a6f9-ebcaee69c005">Explore Relationships of Experiment: IgyFc34</button>
      <br/>
      <br/>
      <hr/>
      <br/>
      <button id="add_tab_2" value="bril:exp-87ac3d68-eb0b-4bff-9ab7-b8fbddf2a49d">Explore Relationships of Experiment: baa5d5</button>  
	</div>
	<div id="tabs-3" class="ui-helper-clearfix">	
	    <h2 id="note">Please select an experiment to view it's relationships.</h2>
	</div>
	{% else %}
	<div id="tabs-2" class="ui-helper-clearfix">
	    <h2>Browse Experiments</h2>
      <button id="add_tab_1" value="bril:exp-5774e47e-2b23-4ae4-a6f9-ebcaee69c005">Explore Relationships of Experiment: IgyFc34</button>
      <br/>
      <br/>
      <hr/>
      <br/>    
      <button id="add_tab_2" value="bril:exp-87ac3d68-eb0b-4bff-9ab7-b8fbddf2a49d">Explore Relationships of Experiment: baa5d5</button>  
	</div>
	<div id="tabs-3" class="ui-helper-clearfix">
	<h2 id="note">Please select an experiment to view it's relationships.</h2>
	</div>
	{% endif %}
</div>
{% endblock %}
